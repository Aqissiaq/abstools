module SchedulingTest;

interface I {
   Unit m(); 
   Unit n();
}

class B implements I {
   // simulate failed assertion
   Unit m() {
   	  assert False;
   }
   
   // simulate deadlock
   Unit n() {
      Fut<Unit> f;
      f = this ! n();
      f.get; 
   }
}

class A implements I {
	Bool mcalled = False;
	Unit m() {
		mcalled = True;
	}
	
	Unit n() {
		assert mcalled;
	}
}

interface J {
   Unit m(J j);
   Unit n(J j);
   Unit k();
}

class C implements J {
   Unit m(J j) {
   	  Fut<Unit> f;
   	  f = j!n(this);
   	  f.get;
   	  
   }
   
   Unit n(J j) {
      Fut<Unit> f;
      f = j!k();
      f.get;
   }
   
   Unit k() {
   }
}

{
   I a;
   I b;
   Fut<Unit> fut1;
   Fut<Unit> fut2;
   a = new cog A();
   b = new cog B();
   b ! m();
   b ! n();
   fut1 = a!m();
   fut2 = a!n();
   J j1;
   J j2;
   j1 = new cog C();
   j2 = new cog C();
   j1!m(j2);

   await fut1? & fut2?;
   fut1.get;
}
