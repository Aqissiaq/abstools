
/*
 * PingPong.abs -- PingPong example
 *
 * An  ABS program. To test core parser.  
 *
 */

data Unit = Unit ;
data String;
data Fut<A>;
data Bool = True | False;

data Msg = NoMsg 
         | HelloPing 
         | HelloPong
         | ThanksPong
         | ThanksPing
         | WhoAreYou 
         ;


interface Ping {

    Unit init(Pong p)  ;
    Msg m(Msg m);
    Unit run()	;
}

interface Pong {

    Unit init(Ping p) ;
    Msg m(Msg m);
    Unit run()	;

}

class PingImpl implements Ping {
    Pong pong ;

    Unit init(Pong p) {
	   pong = p ; 
    }


    Unit run(){
      Fut<Msg> reply;
      reply = pong!m(HelloPong); 
      await reply? ; 
      this!run();
   }

    Msg m(Msg msg){
      Msg reply = NoMsg;
   	if (msg == HelloPing) 
	      reply = ThanksPong ;
	   else
	      reply = WhoAreYou ;
      return reply;
     }
} 

class PongImpl implements Pong {

    Ping ping ;

    Unit init(Ping p){
   	ping = p ; 
    }

    Unit run(){
      Fut<Msg> reply;
      reply = ping!m(HelloPing); 
      await reply? ; 
      this!run();
   }

    Msg m(Msg msg){
	    Msg reply = NoMsg;
	if (msg == HelloPong)  
	  reply = ThanksPing ;
	else
	   reply = WhoAreYou ;
	   return reply;
    } 

}

{
    Ping ping;
    Pong pong;
     
    ping = new PingImpl(); 
    pong = new PongImpl(); 

    ping.init(pong); 
    pong.init(ping); 
    ping!run(); 
    pong!run(); 
}
