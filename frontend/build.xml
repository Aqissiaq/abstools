<?xml version="1.0"?>
<project name="ABS Frontend" default="compile" basedir=".">
<!-- $Id$ -->

  <property environment = "env" /> <!-- include environment variables -->

  <property name = "src.dir"   value = "${basedir}/src" />
  <property name = "build.dir" value = "${basedir}/bin" />
  <property name = "dist.dir"  value = "${basedir}/dist" />
  <property name = "gen.dir"   value = "${basedir}/gen" />
  <property name = "ext.dir"   value = "${basedir}/lib"   />
  <property name = "ast.src.dir" value = "${src.dir}/abs/frontend/ast" />  
  <!-- TODO: about ast.gen.dir and JastAdd idiosyncrasies -->
  <property name = "apidoc.dir" value = "${gen.dir}/docs/api" />
  <property name = "ast.gen.dir" value = "${gen.dir}/abs/frontend" />  
  <property name = "parser.src.dir" value = "${src.dir}/abs/frontend/parser" />
  <property name = "parser.gen.dir" value = "${gen.dir}/abs/frontend/parser" />

  <!-- The package name of JastAdd generated files -->
  <property name="ast.package" value="abs.frontend.ast"/>

  <!-- "jflex" is an ant task class for the scanner generator in JFlex.jar -->
  <taskdef name="jflex" classname="JFlex.anttask.JFlexTask" 
	   classpath="${ext.dir}/JFlex.jar"/>

  <!-- "beaver" is an ant task class for the parser generator in beaver.jar -->
  <taskdef name="beaver" classname="beaver.comp.run.AntTask" 
	   classpath="${ext.dir}/beaver.jar"/>

  <!-- "jastadd" is an ant task class in jastadd2.jar -->
  <taskdef name="jastadd" classname="jastadd.JastAddTask"
	   classpath="${ext.dir}/jastadd2.jar"/>


  <target name = "prepare">
    <mkdir dir = "${gen.dir}"/>
    <mkdir dir = "${ast.gen.dir}"/>
    <mkdir dir = "${parser.gen.dir}" />
    <mkdir dir = "${build.dir}"/>
    <!-- <mkdir dir = "${dist.dir}"/> -->
    <mkdir dir = "${apidoc.dir}"/>
  </target>

  <target name = "compile" depends = "prepare, gen"
	  description = "Compiles all java files into the source directory.">
    <!--  	<copy todir = "${build.dir}">
	 <fileset dir = "${basedir}/resources/"/>
	 </copy> -->
    <javac srcdir =  "${src.dir}:${gen.dir}"
	   destdir = "${build.dir}"
	   deprecation = "on"
	   debug = "on"
	   depend = "${build.depend}"
	   optimize = "off">
      <classpath>
	<pathelement location = "${ext.dir}/beaver.jar" />
	<pathelement location = "${ext.dir}/jastadd2.jar" />
	<pathelement location = "${ext.dir}/JastAddParser.jar" />
      </classpath>
    </javac>
  </target>

  <target name="javadoc" depends="gen,compile" description="Build java doc.">
    <javadoc sourcepath="${src.dir}:${gen.dir}" 
             destdir ="${apidoc.dir}">
      <classpath>
	<pathelement location = "${ext.dir}/beaver.jar" />
	<pathelement location = "${ext.dir}/jastadd2.jar" />
	<pathelement location = "${ext.dir}/JastAddParser.jar" />
      </classpath>
    </javadoc>
  </target>


  <target name = "clean">
    <delete failonerror = "false" includeemptydirs = "true"> 
      <fileset dir = "${gen.dir}"/>
      <fileset dir = "${ast.gen.dir}"/>
      <fileset dir = "${parser.gen.dir}"/>
      <fileset dir = "${build.dir}"/>
      <fileset dir = "${dist.dir}"/>
      <fileset dir = "${apidoc.dir}"/>
    </delete>
  </target>

 <target name="test" depends="compile">
    <java classname="abs.frontend.tests.ParserTest">
        <arg value="tests/block.abs"/>
    <classpath>
    <pathelement location="${ext.dir}/beaver-rt.jar"/>
        <pathelement path="${build.dir}"/>
     </classpath>
       </java>
    <java classname="abs.frontend.tests.ParserTest">
        <arg value="tests/skeleton.abs"/>
      <classpath>
	   <pathelement location="${ext.dir}/beaver-rt.jar"/>
           <pathelement path="${build.dir}"/>
         </classpath>
       </java>
 </target>


<!-- To run from command line: 

      java -cp lib/beaver-rt.jar:bin abs.frontend.tests.ParserTest tests/block.abs
  
-->

  <!--  <target name = "jar" depends = "compile">
       <jar destfile = "${dist.dir}/frontend.jar"
       basedir = "${build.dir}"
       manifest = "${basedir}/resources/MANIFEST.MF"
       />
       </target> -->
  
<!--   <target name="absParser" depends="prepare"> -->
<!--     <antlr:antlr3 xmlns:antlr="antlib:org/apache/tools/ant/antlr" -->
<!-- 		  target="${parser.src.dir}/ABS.g" -->
<!-- 		  outputdirectory="${parser.gen.dir}" -->
<!-- 		  libdirectory="${parser.gen.dir}"		   -->
<!-- 		  multithreaded="true"> -->
<!--       <classpath> -->
<!-- 	<pathelement location = "${ext.dir}/antlr-3.2.jar" /> -->
<!--       </classpath> -->
<!--     </antlr:antlr3>  -->
<!--   </target> -->

  <target name="gen" depends="genparser, genast">
  </target>

  <target name="genast">
    <jastadd package="${ast.package}" rewrite="true" beaver="true"
	     novisitcheck="true" outdir="${gen.dir}" debug="true">
      <fileset dir=".">
        <include name="**/*.ast"/>
        <include name="**/*.jrag"/>
        <include name="**/*.jadd"/>
      </fileset>
    </jastadd>
  </target>

  <target name="genparser" depends="genflex,genp1,genp2">
  
   </target>


   <target name="genflex">
<!-- generate the scanner -->
    <echo message = "Running jflex"/>
    <jflex file="${parser.src.dir}/ABS.flex" outdir="${parser.gen.dir}"
	     nobak="yes"/>
</target> 

   <target name="genp1" depends="genflex">
    <echo message = "Parser phase1"/>
    <!-- generate the parser phase 1, translating .lalr to .beaver -->
    <java fork="true" dir="${parser.src.dir}" 
	    classpath="${ext.dir}/JastAddParser.jar:${ext.dir}/beaver-rt.jar"
	    classname="Main">
	<arg line="ABS.parser '${parser.gen.dir}/ABSParser.beaver'"/>
    </java>
</target> 

   <target name="genp2" depends="genp1">
    <!-- generate the parser phase 2, translating .beaver to .java -->

    <echo message = "Parser phase"/>
    <beaver file="${parser.gen.dir}/ABSParser.beaver"
	    terminalNames="yes" compress="no" useSwitch="yes"/>
  
   </target> 

   <!-- KATJA -->
   
   <property name = "ast.katja.gen.dir" value = "${gen.dir}/abs/frontend/ast/katja" />
   
   <target name="ast.katja.deps">
      <dependset>
         <srcfileset dir="${ast.src.dir}" includes="ast.katja" />
         <targetfileset dir="${ast.katja.gen.dir}" includes="*.java" />
      </dependset>
      <available property="ast.katja.up-to-date" file="${ast.katja.gen.dir}/AST.java" />
   </target>   
   
   <target name="ast.katja" depends="prepare, ast.katja.deps" unless="ast.katja.up-to-date">
     <java jar="${ext.dir}/katja.jar" fork="true">
        <arg line="-b java"/>
        <arg value="-o"/>
        <arg value="-s"/>
        <arg line="-d ${gen.dir}"/>
        <arg value="${ast.src.dir}/ast.katja"/>
     </java>
      <unzip src="${gen.dir}/AST.jar" dest="${gen.dir}" />
      <delete file="${gen.dir}/AST.jar" />
   </target>
   
   <!-- END KATJA -->

</project>
